



<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Wallet Merchant Protocol</title>

    <!-- CSS -->
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css' rel='stylesheet'>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" rel="stylesheet">
    <link href='../../_static/main.css' rel='stylesheet'>
    <link href='../../_static/style.css' rel='stylesheet'>
    <link href='../../_static/doxygen.css' rel='stylesheet'>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

    <!-- Sphinx search -->
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="searchindex.js"></script>
    <!-- Transifex -->
    <script type="text/javascript">
      window.liveSettings = {
        api_key: "bbf87af0641e4bbf89c98088d48e0449",
      };
    </script>
    <script type="text/javascript" src="http://cdn.transifex.com/live.js"></script>

    <!-- title card -->
    <link  href='../../_static/title-card.css' rel='stylesheet'>
    <script src='../../_static/script.js'></script>
    
    <!-- Sphinx search -->
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Graphene Technical Documentation  documentation"
          href="../../_static/opensearch.xml"/>

    <!-- Meta -->
    <meta content="Graphene Documentation" property="og:site_name">
    <meta content="Graphene Documentation" property="og:title">
    <meta content="website" property="og:type">
    <meta content="Graphene Documentation" name="description">
    <meta content="Graphene Documentation" property="og:description">
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-68381245-1', 'auto');
  ga('send', 'pageview');

</script>

 </head>
 <body class='no-literate'>


 <div class='title-area title-card' style='background-image: url(https://bitshares.org/images/bg.jpg)'>
   <div class='in'>
     <div class='headline'>
       <h1>Wallet Merchant Protocol</h1>
 
     </div>
   </div>
 </div>

 <div class='header'>
   <div class='left navlinks'>
    
        <div class="prev">
         <div class="title">previous</div>
         <span><a href="login-protocol.html">Wallet Login Protocol</a></span>
        </div>
        <div class="top">
         <div class="title">top</div>
         <span><a class="uplink" href="../../index.html">Contents</a></span>
        </div>
        <div class="next">
         <div class="title">next</div>
         <span><a href="../libraries/index.html">Supporting Libraries</a></span>
        </div>

   </div>
 </div>

 <div class='content-root'>
  <!-- menu bar -->
  <div class='menubar'>
   <div class='section'>
    <a href="../..//index.html"><img src="../../_static/grphn-logo.svg" height="48" /></a>

    <a href="../..//bitshares/index.html"><img src="../../_static/bitshares-logo.png" height="48" /></a>

    <a href="../..//muse/index.html"><img src="../../_static/MUSE_logo_transp_v1.png" height="48" /></a>
   </div>
   <div class='menu section'>
    <div id="toc">
      <h3>Table Of Contents</h3>
      <ul>
<li class="toctree-l1"><a class="reference internal" href="../../bitshares/index.html">BitShares 2.0</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../muse/index.html">MUSE</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Integration Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#basic-knowledge">Basic Knowledge</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#use-cases">Use-Cases</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../exchanges/index.html">Exchanges, Bridges, and Gateways</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Merchants</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="index.html#protocols-api">Protocols/API</a><ul class="current">
<li class="toctree-l5"><a class="reference internal" href="login-protocol.html">Wallet Login Protocol</a></li>
<li class="toctree-l5 current"><a class="current reference internal" href="">Wallet Merchant Protocol</a></li>
</ul>
</li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html#libraries">Libraries</a><ul class="current">
<li class="toctree-l5"><a class="reference internal" href="login-protocol.html">Wallet Login Protocol</a></li>
<li class="toctree-l5 current"><a class="current reference internal" href="">Wallet Merchant Protocol</a></li>
<li class="toctree-l5"><a class="reference internal" href="../libraries/index.html">Supporting Libraries</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../traders/index.html">Traders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../traders/python-binding.html">Python Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../businesses/index.html">Businesses</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">Graphene API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../blockchain/index.html">Blockchain Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../namespaces/index.html">Namespaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testnet/index.html">Testnets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently Asked Questions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../meta/index.html">How to Contribute</a></li>
</ul>

    </div>
   </div>
   <div class="search section">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
   </div>
   <div class='bottom section'>
    <p class="centered">
     <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
    </p>
   </div>
  </div>
  <div class='content'>
   
  <div class="section" id="wallet-merchant-protocol">
<h1>Wallet Merchant Protocol<a class="headerlink" href="#wallet-merchant-protocol" title="Permalink to this headline">¶</a></h1>
<p>The purpose of this protocol is to enable a merchant to request payment from the
user via a hosted wallet provider or via a browser plugin. We will assume that
the wallet is hosted at <code class="docutils literal"><span class="pre">https://wallet.org</span></code> and that the merchant is hosted
at <code class="docutils literal"><span class="pre">https://merchant.org</span></code>.</p>
<div class="section" id="privacy-concerns">
<h2>Privacy Concerns<a class="headerlink" href="#privacy-concerns" title="Permalink to this headline">¶</a></h2>
<p>The goal of this protocol is to maintain user and merchant privacy from
the wallet provider which should never have direct access to the invoice
data.</p>
<p>To securely pass data from <code class="docutils literal"><span class="pre">https://merchant.org</span></code> to the javascript wallet
hosted at <code class="docutils literal"><span class="pre">https://wallet.org</span></code>, the data will have to be passed after the
<code class="docutils literal"><span class="pre">#</span></code>. Assuming the wallet provider is not serving up pages designed to
compromise your privacy, only your web browser will have access to the invoice
data.</p>
</div>
<div class="section" id="step-1-define-your-invoice-via-json">
<h2>Step 1: Define your Invoice via JSON<a class="headerlink" href="#step-1-define-your-invoice-via-json" title="Permalink to this headline">¶</a></h2>
<p>This invoice provides all of the data needed by the wallet to display an invoice
to the user.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
   <span class="s">&quot;to&quot;</span> <span class="p">:</span> <span class="s">&quot;merchant_account_name&quot;</span><span class="p">,</span>
   <span class="s">&quot;to_label&quot;</span> <span class="p">:</span> <span class="s">&quot;Merchant Name&quot;</span><span class="p">,</span>
   <span class="s">&quot;memo&quot;</span> <span class="p">:</span> <span class="s">&quot;Invoice #1234&quot;</span><span class="p">,</span>
   <span class="s">&quot;currency&quot;</span><span class="p">:</span> <span class="s">&quot;BTS&quot;</span><span class="p">,</span>
   <span class="s">&quot;line_items&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s">&quot;label&quot;</span> <span class="p">:</span> <span class="s">&quot;Something to Buy&quot;</span><span class="p">,</span> <span class="s">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;price&quot;</span> <span class="p">:</span> <span class="s">&quot;1000.00 SYMBOL&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&quot;label&quot;</span> <span class="p">:</span> <span class="s">&quot;10 things to Buy&quot;</span><span class="p">,</span> <span class="s">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&quot;price&quot;</span> <span class="p">:</span> <span class="s">&quot;1000.00 SYMBOL&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&quot;label&quot;</span> <span class="p">:</span> <span class="s">&quot;User Specified Price&quot;</span><span class="p">,</span> <span class="s">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;price&quot;</span> <span class="p">:</span> <span class="s">&quot;CUSTOM SYMBOL&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&quot;label&quot;</span> <span class="p">:</span> <span class="s">&quot;User Asset and Price&quot;</span><span class="p">,</span> <span class="s">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;price&quot;</span> <span class="p">:</span> <span class="s">&quot;CUSTOM&quot;</span> <span class="p">}</span>
    <span class="p">],</span>
    <span class="s">&quot;note&quot;</span> <span class="p">:</span> <span class="s">&quot;Something the merchant wants to say to the user&quot;</span><span class="p">,</span>
    <span class="s">&quot;callback&quot;</span> <span class="p">:</span> <span class="s">&quot;https://merchant.org/complete&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>By itself this data is 579 characters which after URL encoding is 916
characters, with a 2000 character limit this approach doesn&#8217;t scale as
well as we would like.</p>
</div>
<div class="section" id="step-2-compress-your-json-representation">
<h2>Step 2: Compress your JSON representation<a class="headerlink" href="#step-2-compress-your-json-representation" title="Permalink to this headline">¶</a></h2>
<p>Using <a class="reference external" href="https://github.com/nmrugg/LZMA-JS/">LZMA-JS</a> library to
compress the JSON into a binary array. This will be the most compact
form of the data. After running the compression the example JSON was
reduced to 281 bytes from 579 bytes.</p>
</div>
<div class="section" id="step-3-convert-to-base58">
<h2>Step 3: Convert to Base58<a class="headerlink" href="#step-3-convert-to-base58" title="Permalink to this headline">¶</a></h2>
<p>Using the <a class="reference external" href="http://cryptocoinjs.com/modules/misc/bs58/">bs58</a> library
encode the compressed data in base58. Base58 is URL friendly and size
efficient. After converting to base58 the string will be 385 characters
which can easily be passed in a URL and easily support much larger
invoices.</p>
</div>
<div class="section" id="step-4-pass-to-wallet">
<h2>Step 4: Pass to Wallet<a class="headerlink" href="#step-4-pass-to-wallet" title="Permalink to this headline">¶</a></h2>
<p>Once the Base58 data is known, it can be passed to the wallet with the
following URL::</p>
<div class="highlight-python"><div class="highlight"><pre>https://wallet.org/#/invoice/BASE58BLOB
</pre></div>
</div>
</div>
<div class="section" id="step-5-receive-callback-from-wallet">
<h2>Step 5: Receive Callback from Wallet<a class="headerlink" href="#step-5-receive-callback-from-wallet" title="Permalink to this headline">¶</a></h2>
<p>After the wallet has signed a transaction, broadcast it, and gotten
confirmation from <a class="reference external" href="https://wallet.org">https://wallet.org</a> that the transaction was included
in <code class="docutils literal"><span class="pre">block</span> <span class="pre">12345</span></code> as <code class="docutils literal"><span class="pre">transaction</span> <span class="pre">4</span></code> wallet will direct the user to
<code class="docutils literal"><span class="pre">https://merchant.org/complete?block=12345&amp;trx=4</span></code></p>
<p>The merchant will then request that transaction from
<code class="docutils literal"><span class="pre">https://wallet.org/api?block=12345&amp;trx=4</span></code> which will respond with the
transaction that was included in the blockchain. The merchant will decrypt the
memo from the transaction and use memo content to confirm payment for the
invoice.</p>
</div>
<div class="section" id="step-6-payment-complete">
<h2>Step 6: Payment Complete<a class="headerlink" href="#step-6-payment-complete" title="Permalink to this headline">¶</a></h2>
<p>At this point the user has successfully made a payment and the merchant
has verified the payment has been received without having to maintain a
full node.</p>
</div>
<div class="section" id="example-python-script">
<h2>Example Python script<a class="headerlink" href="#example-python-script" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">lzma</span>
<span class="kn">from</span> <span class="nn">graphenebase.base58</span> <span class="kn">import</span> <span class="n">base58encode</span><span class="p">,</span> <span class="n">base58decode</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span><span class="p">,</span> <span class="n">unhexlify</span>

<span class="n">invoice</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;to&quot;</span><span class="p">:</span> <span class="s">&quot;bitshareseurope&quot;</span><span class="p">,</span>
    <span class="s">&quot;to_label&quot;</span><span class="p">:</span> <span class="s">&quot;BitShares Europre&quot;</span><span class="p">,</span>
    <span class="s">&quot;currency&quot;</span><span class="p">:</span> <span class="s">&quot;EUR&quot;</span><span class="p">,</span>
    <span class="s">&quot;memo&quot;</span><span class="p">:</span> <span class="s">&quot;Invoice #1234&quot;</span><span class="p">,</span>
    <span class="s">&quot;line_items&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">&quot;label&quot;</span><span class="p">:</span> <span class="s">&quot;Something to Buy&quot;</span><span class="p">,</span> <span class="s">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;price&quot;</span><span class="p">:</span> <span class="s">&quot;10.00&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;label&quot;</span><span class="p">:</span> <span class="s">&quot;10 things to Buy&quot;</span><span class="p">,</span> <span class="s">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&quot;price&quot;</span><span class="p">:</span> <span class="s">&quot;1.00&quot;</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s">&quot;note&quot;</span><span class="p">:</span> <span class="s">&quot;Payment for reading awesome documentation&quot;</span><span class="p">,</span>
    <span class="s">&quot;callback&quot;</span><span class="p">:</span> <span class="s">&quot;https://bitshares.eu/complete&quot;</span>
<span class="p">}</span>

<span class="n">compressed</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">invoice</span><span class="p">),</span> <span class="s">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">format</span><span class="o">=</span><span class="n">lzma</span><span class="o">.</span><span class="n">FORMAT_ALONE</span><span class="p">)</span>
<span class="n">b58</span> <span class="o">=</span> <span class="n">base58encode</span><span class="p">(</span><span class="n">hexlify</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://bitshares.openledger.info/#/invoice/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">b58</span>

<span class="k">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


  </div>
 </div>

 <script>var HN=[];HN.factory=function(e){return function(){HN.push([e].concat(Array.prototype.slice.call(arguments,0)))};},HN.on=HN.factory("on"),HN.once=HN.factory("once"),HN.off=HN.factory("off"),HN.emit=HN.factory("emit"),HN.load=function(){var e="hn-button.js";if(document.getElementById(e))return;var t=document.createElement("script");t.id=e,t.src="//hn-button.herokuapp.com/hn-button.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n)},HN.load();</script>
 <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
 </body>
</html>